<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o H√≠drica - Base Naval & Lespan</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíß</text></svg>">

    <!-- Bibliotecas -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --navy-primary: #0a2342;
            --navy-secondary: #2ca58d;
            --money-color: #198754;
            --lespan-color: #e56b6f;
            --bg-color: #f4f6f9;
        }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; background: white; }
        .card-header { background-color: white; border-bottom: 1px solid #eee; font-weight: 700; color: var(--navy-primary); padding: 15px; }
        
        /* Navega√ß√£o */
        .nav-pills .nav-link { color: var(--navy-primary); font-weight: 600; margin-right: 10px; background: white; border: 1px solid #dee2e6; }
        .nav-pills .nav-link.active { background-color: var(--navy-primary); color: white; border-color: var(--navy-primary); }
        
        /* KPIs */
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--navy-primary); }
        .kpi-label { font-size: 0.8rem; color: #6c757d; text-transform: uppercase; font-weight: 700; }
        .money-text { color: var(--money-color); }
        
        /* Tabelas */
        .table th { background-color: #f8f9fa; }
        .trend-up { color: #dc3545; font-weight: bold; } /* Vermelho se subir consumo */
        .trend-down { color: #198754; font-weight: bold; } /* Verde se cair consumo */
        
        /* Tooltip customizado para detalhes */
        .tax-detail { cursor: pointer; color: var(--navy-primary); text-decoration: underline; }
        .tax-detail:hover { color: var(--navy-secondary); }
    </style>
</head>
<body>

<div class="container py-4">
    
    <!-- Topo -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold mb-0 text-primary"><i class="fa-solid fa-faucet-drip me-2"></i>Gest√£o H√≠drica</h2>
            <p class="text-muted mb-0">Monitoramento: Base Naval & Lespan</p>
        </div>
        <div class="bg-white p-2 rounded border d-flex align-items-center">
            <label class="fw-bold text-muted me-2 small">ANO DE VISUALIZA√á√ÉO:</label>
            <select id="yearSelect" class="form-select form-select-sm fw-bold border-0 bg-light" style="width: 100px;" onchange="updateUI()">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
            </select>
        </div>
    </div>

    <!-- KPIs (Indicadores) -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-4 border-primary">
                <div class="kpi-label">CONSUMO TOTAL</div>
                <div class="kpi-value" id="kpiVol">0</div>
                <small class="text-muted">Metros C√∫bicos (m¬≥)</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-4 border-success">
                <div class="kpi-label">CUSTO TOTAL (ECON√îMICO)</div>
                <div class="kpi-value money-text" id="kpiCost">R$ 0,00</div>
                <small class="text-muted">Fatura + Extras (Impostos)</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-4 border-warning">
                <div class="kpi-label">PRE√áO M√âDIO</div>
                <div class="kpi-value text-warning" id="kpiAvg">R$ 0,00</div>
                <small class="text-muted">Por m¬≥</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-4 border-danger">
                <div class="kpi-label">MAIOR FATURA</div>
                <div class="kpi-value text-danger" id="kpiMax">R$ 0,00</div>
                <small class="text-muted" id="kpiMaxMonth">-</small>
            </div>
        </div>
    </div>

    <!-- Menu de Abas -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-dash">üìä Dashboard</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-2025">2025 Detalhado</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-2024">2024 Detalhado</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-comp">‚öñÔ∏è Comparativo</button></li>
    </ul>

    <div class="tab-content">
        
        <!-- ABA 1: DASHBOARD -->
        <div class="tab-pane fade show active" id="tab-dash">
            <!-- Gr√°fico Financeiro -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-chart-mixed me-2"></i>An√°lise: Consumo (m¬≥) vs Custo Econ√¥mico (R$)</span>
                </div>
                <div class="card-body">
                    <canvas id="chartFinance" height="80"></canvas>
                </div>
            </div>
            <!-- Gr√°fico Volume -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header">Volume por Unidade</div>
                        <div class="card-body">
                            <canvas id="chartVolume" height="150"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">Resumo</div>
                        <div class="card-body">
                            <div class="alert alert-primary">
                                <strong><i class="fas fa-info-circle"></i> Status dos Dados</strong><br>
                                <span id="statusText"></span><br>
                                <small>Valores com √≠cone <i class="fas fa-eye"></i> incluem impostos retidos.</small>
                            </div>
                            <hr>
                            <ul class="list-unstyled" id="statusList"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 2: 2025 -->
        <div class="tab-pane fade" id="tab-2025">
            <div class="card">
                <div class="card-header bg-primary text-white">Faturas de 2025</div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-striped table-hover mb-0 align-middle text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>M√™s</th>
                                <th>Vol. Total (m¬≥)</th>
                                <th>Servi√ßos + Taxas</th>
                                <th>Extras (Reten√ß√µes)</th>
                                <th>Total (R$)</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2025"></tbody>
                    </table>
                </div>
                <div class="card-footer small text-muted">
                    * Custo Total = Valor L√≠quido da Fatura + Extras (Reten√ß√µes).
                </div>
            </div>
        </div>

        <!-- ABA 3: 2024 -->
        <div class="tab-pane fade" id="tab-2024">
            <div class="card">
                <div class="card-header bg-secondary text-white">Faturas de 2024</div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-striped table-hover mb-0 align-middle text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>M√™s</th>
                                <th>Vol. Total (m¬≥)</th>
                                <th>Servi√ßos + Taxas</th>
                                <th>Extras (Reten√ß√µes)</th>
                                <th>Total (R$)</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2024"></tbody>
                    </table>
                </div>
                <div class="card-footer small text-muted">
                    * Meses sem bot√£o "Ver Detalhes" s√£o estimados via hist√≥rico (sem extras).
                </div>
            </div>
        </div>

        <!-- ABA 4: COMPARATIVO -->
        <div class="tab-pane fade" id="tab-comp">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Comparativo de Volume (m¬≥)</div>
                        <div class="card-body"><canvas id="chartCompVol" height="150"></canvas></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Comparativo Financeiro (R$)</div>
                        <div class="card-body"><canvas id="chartCompFin" height="150"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Tabela de Varia√ß√£o (2025 vs 2024)</div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-bordered text-center mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>M√™s</th><th>m¬≥ 2024</th><th>m¬≥ 2025</th><th>Var. Vol</th><th>R$ 2024</th><th>R$ 2025</th><th>Var. R$</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyComp"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="detailModalTitle"><i class="fa-solid fa-file-invoice-dollar me-2"></i>Detalhamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-calculator me-1"></i> F√≥rmula: <strong>Custo Total = Fatura (L√≠quido) + Extras (Reten√ß√µes)</strong>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle text-center mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Unidade</th>
                                <th>Matr√≠cula</th>
                                <th>Fatura</th>
                                <th>Valor Fatura (L√≠quido)</th>
                                <th>Extras (Reten√ß√µes)</th>
                                <th class="table-primary">Custo Total</th>
                            </tr>
                        </thead>
                        <tbody id="modalBodyContent">
                            <!-- Preenchido via JS -->
                        </tbody>
                        <tfoot class="fw-bold bg-light">
                            <tr id="modalFooterContent">
                                <!-- Totais via JS -->
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-3 small text-muted">
                    * Valor Fatura: Total a pagar conforme boleto.<br>
                    * Extras: Impostos retidos (PIS, COFINS, CSLL, IRRF). Para faturas com abatimento, o Custo Total considera o valor pago + impostos.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // =====================================================
    // DADOS DOS GR√ÅFICOS E TABELAS
    // =====================================================
    
    // NOMES DOS MESES
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

    // BASE DE DADOS - VOLUME (m¬≥)
    const dataVol = {
        baseNaval: {
            // 2024: Todos reais exceto Dez
            2024: [
                39599, // Jan (Real)
                37609, // Fev (Real)
                38758, // Mar (Real)
                40874, // Abr (Real)
                39625, // Mai (Real)
                33576, // Jun (Real)
                32257, // Jul (Real)
                29161, // Ago (Real)
                30129, // Set (Real)
                37508, // Out (Real)
                24498, // Nov (Real)
                28735  // Dez (Hist)
            ],
            // 2025: Jan-Nov Reais (Out recuperado historico)
            2025: [29523, 31152, 31525, 35663, 33971, 28708, 31069, 31039, 30794, 35359, 33714, 0]
        },
        lespan: {
            // 2024: Todos reais exceto Dez
            2024: [
                171, // Jan (Real)
                75,  // Fev (Real)
                124, // Mar (Real)
                111, // Abr (Real)
                217, // Mai (Real)
                54,  // Jun (Real)
                71,  // Jul (Real)
                287, // Ago (Real)
                109, // Set (Real)
                153, // Out (Real)
                166, // Nov (Real)
                254  // Dez (Hist)
            ],
            // 2025: Jan-Nov Reais (Out recuperado historico)
            2025: [103, 133, 324, 352, 417, 555, 763, 567, 706, 518, 534, 0]
        }
    };

    // BASE DE DADOS - FINANCEIRO (R$)
    // Valores consolidados (Fatura + Extras onde dispon√≠vel)
    const dataFin = {
        2024: [
            1441790.90,    // Jan (Real)
            1369634.68,    // Fev (Real)
            1441004.66,    // Mar (Real)
            1505183.50,    // Abr (Real)
            1424092.24,    // Mai (Real)
            1234906.82,    // Jun (Real)
            1183307.31,    // Jul (Real)
            1081229.48,    // Ago (Real)
            1110259.89,    // Set (Real)
            1383035.36,    // Out (Real)
            905430.22,     // Nov (Real)
            1084810.48     // Dez (Hist√≥rico Recuperado)
        ],
        2025: [
            1226744.52, // Jan
            1295497.13, // Fev
            1318870.48, // Mar
            1530665.50, // Abr
            1424092.24, // Mai
            1216867.34, // Jun
            1318165.99, // Jul
            963218.31,  // Ago
            1304407.19, // Set
            1485799.64, // Out
            1418290.31, // Nov
            0           // Dez
        ]
    };

    // Detalhamento Completo (2024 e 2025)
    // Structure: year -> monthIndex -> Array of objects
    const detailsData = {
        2024: {
            0: [ // Jan
                {unit: 'Base Naval', mat: '400485340-0', fat: '194705', liq: 641877.95, ext: 66292.32},
                {unit: 'Base Naval', mat: '400447071-3', fat: '194703', liq: 662942.28, ext: 68467.81},
                {unit: 'Lespan',     mat: '400485344-2', fat: '194704', liq: 2003.61,   ext: 206.93}
            ],
            1: [ // Fev
                {unit: 'Base Naval', mat: '400485340-0', fat: '251794', liq: 608946.38, ext: 62891.19},
                {unit: 'Base Naval', mat: '400447071-3', fat: '251792', liq: 630274.42, ext: 65093.93},
                {unit: 'Lespan',     mat: '400485344-2', fat: '251793', liq: 2201.40,   ext: 227.36}
            ],
            2: [ // Mar
                {unit: 'Base Naval', mat: '400485340-0', fat: '342907', liq: 640138.88, ext: 66126.11},
                {unit: 'Base Naval', mat: '400447071-3', fat: '342905', liq: 662130.94, ext: 68397.88},
                {unit: 'Lespan',     mat: '400485344-2', fat: '342906', liq: 3816.67,   ext: 394.18}
            ],
            3: [ // Abr
                {unit: 'Base Naval', mat: '400485340-0', fat: '438592', liq: 682286.40, ext: 55334.82},
                {unit: 'Base Naval', mat: '400447071-3', fat: '438590', liq: 706473.23, ext: 57312.11},
                {unit: 'Lespan',     mat: '400485344-2', fat: '438591', liq: 3427.01,   ext: 349.93}
            ],
            4: [ // Mai
                {unit: 'Base Naval', mat: '400485340-0', fat: '523428', liq: 673150.56, ext: 68733.36},
                {unit: 'Base Naval', mat: '400447071-3', fat: '523426', liq: 697257.40, ext: 71194.85},
                {unit: 'Lespan',     mat: '400485344-2', fat: '523427', liq: 7038.88,   ext: 717.19}
            ],
            5: [ // Jun
                {unit: 'Base Naval', mat: '400485340-0', fat: '612775', liq: 551282.61, ext: 56289.79},
                {unit: 'Base Naval', mat: '400447071-3', fat: '612773', liq: 567687.27, ext: 57964.82},
                {unit: 'Lespan',     mat: '400485344-2', fat: '612774', liq: 1526.47,   ext: 155.86}
            ],
            6: [ // Jul
                {unit: 'Base Naval', mat: '400485340-0', fat: '712039', liq: 526075.45, ext: 53715.97},
                {unit: 'Base Naval', mat: '400447071-3', fat: '712037', liq: 545580.99, ext: 55707.62},
                {unit: 'Lespan',     mat: '400485344-2', fat: '712038', liq: 1877.36,   ext: 349.92}
            ],
            7: [ // Ago
                {unit: 'Base Naval', mat: '400485340-0', fat: '805792', liq: 477028.18, ext: 48707.91},
                {unit: 'Base Naval', mat: '400447071-3', fat: '805791', liq: 494733.23, ext: 50515.71},
                {unit: 'Lespan',     mat: '400485344-2', fat: '805793', liq: 9295.33,   ext: 949.12}
            ],
            8: [ // Set
                {unit: 'Base Naval', mat: '400485340-0', fat: '921664', liq: 492399.23, ext: 50277.39},
                {unit: 'Base Naval', mat: '400447071-3', fat: '921662', liq: 511638.03, ext: 52241.80},
                {unit: 'Lespan',     mat: '400485344-2', fat: '921663', liq: 3360.33,   ext: 343.11}
            ],
            9: [ // Out
                {unit: 'Base Naval', mat: '400485340-0', fat: '22139', liq: 615367.48, ext: 62833.31},
                {unit: 'Base Naval', mat: '400447071-3', fat: '22137', liq: 634706.31, ext: 64807.94},
                {unit: 'Lespan',     mat: '400485344-2', fat: '22138', liq: 4827.41,   ext: 492.91}
            ],
            10: [ // Nov
                {unit: 'Base Naval', mat: '400485340-0', fat: '118147', liq: 403273.91, ext: 41177.08},
                {unit: 'Base Naval', mat: '400447071-3', fat: '118145', liq: 413010.01, ext: 42171.19},
                {unit: 'Lespan',     mat: '400485344-2', fat: '118146', liq: 5260.86,   ext: 537.17}
            ]
        },
        2025: {
            0: [ // Jan
                {unit: 'Base Naval', mat: '400485340-0', fat: '342980', liq: 544553.98, ext: 55602.76},
                {unit: 'Base Naval', mat: '400447071-3', fat: '342978', liq: 564972.25, ext: 57687.61},
                {unit: 'Lespan',     mat: '400485344-2', fat: '342979', liq: 3564.01,   ext: 363.91}
            ],
            1: [ // Fev
                {unit: 'Base Naval', mat: '400485340-0', fat: '465919', liq: 573620.86, ext: 58570.69},
                {unit: 'Base Naval', mat: '400447071-3', fat: '465917', liq: 597160.17, ext: 60974.21},
                {unit: 'Lespan',     mat: '400485344-2', fat: '465918', liq: 4692.10,   ext: 479.10}
            ],
            2: [ // Mar
                {unit: 'Base Naval', mat: '400485340-0', fat: '557654', liq: 577569.14, ext: 58973.83},
                {unit: 'Base Naval', mat: '400447071-3', fat: '557652', liq: 607237.67, ext: 62003.20},
                {unit: 'Lespan',     mat: '400485344-2', fat: '557653', liq: 11874.20,  ext: 1212.44}
            ],
            3: [ // Abr
                {unit: 'Base Naval', mat: '400485340-0', fat: '619993', liq: 654128.24, ext: 66791.05},
                {unit: 'Base Naval', mat: '400447071-3', fat: '619991', liq: 721725.99, ext: 73773.19},
                {unit: 'Lespan',     mat: '400485344-2', fat: '619992', liq: 12927.08,  ext: 1319.95}
            ],
            4: [ // Mai
                {unit: 'Base Naval', mat: '400485340-0', fat: '707740', liq: 624346.91, ext: 63750.17},
                {unit: 'Base Naval', mat: '400447071-3', fat: '707738', liq: 652436.12, ext: 66618.27},
                {unit: 'Lespan',     mat: '400485344-2', fat: '707739', liq: 15371.25,  ext: 1569.52}
            ],
            5: [ // Jun
                {unit: 'Base Naval', mat: '400485340-0', fat: '791732', liq: 528460.02, ext: 53959.47},
                {unit: 'Base Naval', mat: '400447071-3', fat: '791730', liq: 550420.00, ext: 56201.72},
                {unit: 'Lespan',     mat: '400485344-2', fat: '791731', liq: 25242.96,  ext: 2583.17}
            ],
            6: [ // Jul
                {unit: 'Base Naval', mat: '400485340-0', fat: '906084', liq: 572605.59, ext: 58467.02},
                {unit: 'Base Naval', mat: '400447071-3', fat: '906082', liq: 595054.40, ext: 60759.21},
                {unit: 'Lespan',     mat: '400485344-2', fat: '906083', liq: 28381.79,  ext: 2897.98}
            ],
            7: [ // Ago (Com abatimentos)
                {unit: 'Base Naval', mat: '400485340-0', fat: '8453',   liq: 464144.13, ext: 47149.63},
                {unit: 'Base Naval', mat: '400447071-3', fat: '8440',   liq: 389466.46, ext: 39300.99},
                {unit: 'Lespan',     mat: '400485344-2', fat: '149330', liq: 21011.66,  ext: 2145.44}
            ],
            8: [ // Set
                {unit: 'Base Naval', mat: '400485340-0', fat: '191552', liq: 571665.53, ext: 58371.03},
                {unit: 'Base Naval', mat: '400447071-3', fat: '191549', liq: 585653.74, ext: 59799.32},
                {unit: 'Lespan',     mat: '400485344-2', fat: '191550', liq: 26238.43,  ext: 2679.14}
            ],
            9: [ // Out
                {unit: 'Base Naval', mat: '400485340-0', fat: '256320', liq: 651044.80, ext: 66476.22},
                {unit: 'Base Naval', mat: '400447071-3', fat: '256318', liq: 677930.76, ext: 69221.44},
                {unit: 'Lespan',     mat: '400485344-2', fat: '256319', liq: 19169.12,  ext: 1957.30}
            ],
            10: [ // Nov
                {unit: 'Base Naval', mat: '400485340-0', fat: '344621', liq: 611073.14, ext: 62394.83},
                {unit: 'Base Naval', mat: '400447071-3', fat: '344619', liq: 656045.97, ext: 66986.86},
                {unit: 'Lespan',     mat: '400485344-2', fat: '344620', liq: 19770.78,  ext: 2018.73}
            ]
        }
    };

    // Vari√°veis globais para os gr√°ficos
    let chVol, chFin, chCmpVol, chCmpFin;

    // INICIALIZAR
    document.addEventListener('DOMContentLoaded', () => {
        updateUI();
        renderTables();
    });

    // Fun√ß√£o para abrir o modal e preencher dados
    window.openDetails = function(year, monthIndex) {
        const modalBody = document.getElementById('modalBodyContent');
        const modalFooter = document.getElementById('modalFooterContent');
        const modalTitle = document.getElementById('detailModalTitle');
        
        // Verifica se existem dados detalhados para o ano/m√™s
        const details = detailsData[year] && detailsData[year][monthIndex];
        
        modalTitle.innerText = `Detalhamento: ${months[monthIndex]}/${year}`;

        let html = '';
        let totalLiq = 0, totalExt = 0, totalGeral = 0;

        if (details) {
            details.forEach(item => {
                const totalItem = item.liq + item.ext;
                totalLiq += item.liq;
                totalExt += item.ext;
                totalGeral += totalItem;

                html += `<tr>
                    <td class="fw-bold text-start">${item.unit}</td>
                    <td>${item.mat}</td>
                    <td>${item.fat}</td>
                    <td>${item.liq.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                    <td class="text-danger">+ ${item.ext.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                    <td class="fw-bold table-primary">${totalItem.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                </tr>`;
            });

            modalBody.innerHTML = html;
            modalFooter.innerHTML = `
                <td colspan="3" class="text-end">TOTAIS:</td>
                <td>${totalLiq.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                <td class="text-danger">+ ${totalExt.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                <td class="table-primary">${totalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
            `;
        } else {
            modalBody.innerHTML = '<tr><td colspan="6" class="text-muted">Dados detalhados n√£o dispon√≠veis para este m√™s (apenas valores hist√≥ricos consolidados).</td></tr>';
            modalFooter.innerHTML = '';
        }

        const modal = new bootstrap.Modal(document.getElementById('detailModal'));
        modal.show();
    };

    // ATUALIZAR TELA AO MUDAR O ANO
    function updateUI() {
        const year = document.getElementById('yearSelect').value;
        
        // 1. Atualizar KPIs
        const volsBN = dataVol.baseNaval[year];
        const volsLP = dataVol.lespan[year];
        const costs = dataFin[year];
        
        let sumVol = 0, sumCost = 0, maxCost = 0, maxCostIdx = 0;

        for(let i=0; i<12; i++) {
            const v = (volsBN[i] || 0) + (volsLP[i] || 0);
            const c = (costs[i] || 0);
            sumVol += v;
            sumCost += c;
            if(c > maxCost) { maxCost = c; maxCostIdx = i; }
        }

        const avgPrice = sumVol > 0 ? (sumCost / sumVol) : 0;

        document.getElementById('kpiVol').innerText = sumVol.toLocaleString('pt-BR');
        document.getElementById('kpiCost').innerText = sumCost.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        document.getElementById('kpiAvg').innerText = avgPrice.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        document.getElementById('kpiMax').innerText = maxCost.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        document.getElementById('kpiMaxMonth').innerText = maxCost > 0 ? months[maxCostIdx] : '-';

        // 2. Atualizar Lista Status
        const filled = volsBN.filter(v => v > 0).length;
        const statusList = document.getElementById('statusList');
        let statusHtml = `<li><strong>Dados preenchidos:</strong> ${filled} de 12 meses</li>`;
        
        if (year === '2025') {
            statusHtml += `<li><small class="text-success"><i class="fas fa-check-circle"></i> Jan-Nov processados (c/ impostos)</small></li>`;
            statusHtml += `<li><small class="text-muted"><i class="fas fa-clock"></i> Dez pendente</small></li>`;
        } else {
            statusHtml += `<li><small class="text-success"><i class="fas fa-check-circle"></i> Jan-Nov (Real)</small></li>`;
            statusHtml += `<li><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Dez (Hist√≥rico)</small></li>`;
        }
        statusList.innerHTML = statusHtml;

        // 3. Renderizar Gr√°ficos
        renderCharts(year);
    }

    function renderCharts(year) {
        const volsBN = dataVol.baseNaval[year];
        const volsLP = dataVol.lespan[year];
        const costs = dataFin[year];
        
        const totalVol = volsBN.map((v, i) => v + (volsLP[i] || 0));
        const cleanData = (arr) => arr.map((v, i) => (year === '2025' && v === 0 && i !== 11) ? null : v); 

        // --- GR√ÅFICO DE VOLUME ---
        if(chVol) chVol.destroy();
        chVol = new Chart(document.getElementById('chartVolume'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: 'Base Naval', data: volsBN, backgroundColor: '#0a2342' },
                    { label: 'Lespan', data: volsLP, backgroundColor: '#e56b6f' }
                ]
            },
            options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } } }
        });

        // --- GR√ÅFICO FINANCEIRO ---
        if(chFin) chFin.destroy();
        chFin = new Chart(document.getElementById('chartFinance'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: 'Custo Total (R$)', data: cleanData(costs), type: 'line', borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', yAxisID: 'y1', tension: 0.3, fill: true },
                    { label: 'Consumo (m¬≥)', data: cleanData(totalVol), backgroundColor: 'rgba(13,110,253,0.4)', yAxisID: 'y' }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { position: 'left', title: { display: true, text: 'Volume (m¬≥)' } },
                    y1: { position: 'right', title: { display: true, text: 'Reais (R$)' }, grid: { drawOnChartArea: false } }
                }
            }
        });

        // --- GR√ÅFICOS COMPARATIVOS ---
        const vol24 = dataVol.baseNaval[2024].map((v, i) => v + dataVol.lespan[2024][i]);
        const vol25 = dataVol.baseNaval[2025].map((v, i) => v + dataVol.lespan[2025][i]);
        const vol25Clean = vol25.map((v, i) => (v === 0 && i !== 11) ? null : v);
        
        if(chCmpVol) chCmpVol.destroy();
        chCmpVol = new Chart(document.getElementById('chartCompVol'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    { label: '2024', data: vol24, borderColor: '#adb5bd', borderDash: [5,5] },
                    { label: '2025', data: vol25Clean, borderColor: '#0a2342', borderWidth: 3 }
                ]
            }
        });

        const fin24 = dataFin[2024];
        const fin25 = dataFin[2025];
        const fin25Clean = fin25.map((v, i) => (v === 0 && i !== 11) ? null : v);

        if(chCmpFin) chCmpFin.destroy();
        chCmpFin = new Chart(document.getElementById('chartCompFin'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: '2024', data: fin24, backgroundColor: '#adb5bd' },
                    { label: '2025', data: fin25Clean, backgroundColor: '#198754' }
                ]
            }
        });
    }

    function renderTables() {
        const tbody25 = document.getElementById('tbody2025');
        const tbody24 = document.getElementById('tbody2024');
        const tbodyComp = document.getElementById('tbodyComp');

        let html25 = '', html24 = '', htmlComp = '';

        for(let i=0; i<12; i++) {
            // FUN√á√ÉO AUXILIAR PARA LINHA
            const createRow = (year, i) => {
                let bn = dataVol.baseNaval[year][i] || 0;
                let lp = dataVol.lespan[year][i] || 0;
                let tot = bn + lp;
                let cost = dataFin[year][i] || 0;
                
                let details = detailsData[year] && detailsData[year][i];
                let service = 0, extras = 0;
                let hasDetails = false;

                if (details) {
                    details.forEach(d => { service += d.liq; extras += d.ext; });
                    hasDetails = true;
                }

                let btn = hasDetails 
                    ? `<button class="btn btn-sm btn-outline-primary" onclick="openDetails(${year}, ${i})"><i class="fas fa-eye"></i> Ver Detalhes</button>` 
                    : '<span class="text-muted text-small">-</span>';

                let srvDisplay = hasDetails ? service.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-';
                let extDisplay = hasDetails ? extras.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-';

                return `<tr>
                    <td>${months[i]}</td>
                    <td>${tot > 0 ? tot.toLocaleString() : '-'}</td>
                    <td>${srvDisplay}</td>
                    <td class="text-danger">${extDisplay}</td>
                    <td class="fw-bold text-success">${cost > 0 ? cost.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-'}</td>
                    <td>${btn}</td>
                </tr>`;
            };

            html25 += createRow(2025, i);
            html24 += createRow(2024, i);

            // Comparativo
            let vol24 = dataVol.baseNaval[2024][i] + dataVol.lespan[2024][i];
            let vol25 = dataVol.baseNaval[2025][i] + dataVol.lespan[2025][i];
            let c24 = dataFin[2024][i] || 0;
            let c25 = dataFin[2025][i] || 0;

            let varVol = (vol25 > 0 && vol24 > 0) ? ((vol25 - vol24)/vol24)*100 : 0;
            let varCost = (c25 > 0 && c24 > 0) ? ((c25 - c24)/c24)*100 : 0;
            
            let classVol = varVol > 0 ? 'trend-up' : (varVol < 0 ? 'trend-down' : '');
            let classCost = varCost > 0 ? 'trend-up' : (varCost < 0 ? 'trend-down' : '');
            
            let arrowVol = varVol > 0 ? '‚ñ≤' : '‚ñº';
            let arrowCost = varCost > 0 ? '‚ñ≤' : '‚ñº';

            let displayVarVol = vol25 > 0 ? `<span class="${classVol}">${varVol > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(varVol).toFixed(1)}%</span>` : '-';
            let displayVarCost = c25 > 0 ? `<span class="${classCost}">${varCost > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(varCost).toFixed(1)}%</span>` : '-';

            htmlComp += `<tr>
                <td>${months[i]}</td>
                <td>${vol24.toLocaleString()}</td>
                <td>${vol25 > 0 ? vol25.toLocaleString() : '-'}</td>
                <td>${displayVarVol}</td>
                <td>${c24.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                <td>${c25 > 0 ? c25.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-'}</td>
                <td>${displayVarCost}</td>
            </tr>`;
        }

        tbody25.innerHTML = html25;
        tbody24.innerHTML = html24;
        tbodyComp.innerHTML = htmlComp;
    }

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
